<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Creating Unit Tests in Go" /><meta property="og:locale" content="en" /><meta name="description" content="Writing unit tests for you functions is an important step in ensuring that the code you have written is creating the output you are expecting. I’ll go over a few different functions in go and how you can go about writing good unit tests for them using go recommended table based testing method." /><meta property="og:description" content="Writing unit tests for you functions is an important step in ensuring that the code you have written is creating the output you are expecting. I’ll go over a few different functions in go and how you can go about writing good unit tests for them using go recommended table based testing method." /><link rel="canonical" href="/posts/creating-unit-tests-golang/" /><meta property="og:url" content="/posts/creating-unit-tests-golang/" /><meta property="og:site_name" content="Grayton Ward" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-03-06T00:00:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Creating Unit Tests in Go" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-03-06T15:30:03-05:00","datePublished":"2023-03-06T00:00:00-05:00","description":"Writing unit tests for you functions is an important step in ensuring that the code you have written is creating the output you are expecting. I’ll go over a few different functions in go and how you can go about writing good unit tests for them using go recommended table based testing method.","headline":"Creating Unit Tests in Go","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/creating-unit-tests-golang/"},"url":"/posts/creating-unit-tests-golang/"}</script><title>Creating Unit Tests in Go | Grayton Ward</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Grayton Ward"><meta name="application-name" content="Grayton Ward"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/profile_pic.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Grayton Ward</a></div><div class="site-subtitle font-italic">A Curious Homelaber</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/graytonio" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/grayton-ward-75b307143/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['graytonio.ward','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Creating Unit Tests in Go</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Creating Unit Tests in Go</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1678078800" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Mar 6, 2023 </em> </span> <span> Updated <em class="" data-ts="1678134603" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Mar 6, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/graytonio">Grayton Ward</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1391 words"> <em>7 min</em> read</span></div></div></div><div class="post-content"><p>Writing unit tests for you functions is an important step in ensuring that the code you have written is creating the output you are expecting. I’ll go over a few different functions in go and how you can go about writing good unit tests for them using go recommended table based testing method.</p><h2 id="simple-pure-functions"><span class="mr-2">Simple Pure Functions</span><a href="#simple-pure-functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>For pure functions unit testing is a breeze due to pure functions properties of never modifying or accessing data outside of its scope. Lets look at an example.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">func</span> <span class="n">reverse</span><span class="p">(</span><span class="n">s</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">result</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">str</span> <span class="p">{</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kt">string</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="n">result</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span>
<span class="p">}</span>
</pre></table></code></div></div><p>This function only acts on its inputs and has no other side effects so lets setup a test function for it. The convention for tests is to create a new file next to the source code with the suffix <code class="language-plaintext highlighter-rouge">_test.go</code> for example if this code is in <code class="language-plaintext highlighter-rouge">mylib.go</code> the test file would be named <code class="language-plaintext highlighter-rouge">mylib_test.go</code>. Test files act just like normal go code and can exist in the same package space. We use go’s <code class="language-plaintext highlighter-rouge">testing</code> package to handle the state of our tests.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">package</span> <span class="n">mylib</span>

<span class="k">import</span> <span class="s">"testing"</span>

<span class="k">func</span> <span class="n">TestReverse</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>

<span class="p">}</span>
</pre></table></code></div></div><p>In this <code class="language-plaintext highlighter-rouge">TestReverse</code> function we can define how we want our tests structured. We should know what input we are putting in as well as what we expect to get out of the function given the input. We will also want to hold a name or id for our test so we can identify which inputs are not giving the correct output. We’ll create a quick struct to hold this information for this test.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">type</span> <span class="n">test</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">name</span> <span class="kt">string</span>
    <span class="n">inputString</span> <span class="kt">string</span>
    <span class="n">expectedOutput</span> <span class="kt">string</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Not that we have a format for how we want to define our tests we can setup a couple of test cases.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="k">var</span> <span class="n">tests</span> <span class="o">=</span> <span class="p">[]</span><span class="n">test</span><span class="p">{</span>
    <span class="p">{</span>
        <span class="n">name</span><span class="o">:</span> <span class="s">"basic string"</span><span class="p">,</span>
        <span class="n">inputString</span><span class="o">:</span> <span class="s">"hello"</span><span class="p">,</span>
        <span class="n">expectedOutput</span><span class="o">:</span> <span class="s">"olleh"</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="n">name</span><span class="o">:</span> <span class="s">"empty string"</span><span class="p">,</span>
        <span class="n">inputString</span><span class="o">:</span> <span class="s">""</span><span class="p">,</span>
        <span class="n">expectedOutput</span><span class="o">:</span> <span class="s">""</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="n">name</span><span class="o">:</span> <span class="s">"single character"</span><span class="p">,</span>
        <span class="n">inputString</span><span class="o">:</span> <span class="s">"a"</span><span class="p">,</span>
        <span class="n">expectedOutput</span><span class="o">:</span> <span class="s">"a"</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>With these test cases we can loop over them and make sure that our cases all return correctly. To do our comparison we are going to use the <code class="language-plaintext highlighter-rouge">testify</code> library which adds assert functions missing from the go std.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">tt</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">tests</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="k">func</span> <span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">output</span> <span class="o">:=</span> <span class="n">reverse</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">inputString</span><span class="p">)</span>
        <span class="n">assert</span><span class="o">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">expectedOutput</span><span class="p">,</span> <span class="s">"output does not match expectedOutput"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Now when we run <code class="language-plaintext highlighter-rouge">go test ./...</code> to run all the tests in our project each of the test cases will be ran and checked against the expected output. If any of the tests fail we will get an output about what output it got against what it should have been which can help us figure out where the bug is. All together our test file will look like.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="k">package</span> <span class="n">mylib</span>

<span class="k">import</span> <span class="p">(</span>
    <span class="s">"testing"</span>

    <span class="s">"github.com/stretchr/testify/assert"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">TestReverse</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">type</span> <span class="n">test</span> <span class="k">struct</span> <span class="p">{</span>
        <span class="n">name</span> <span class="kt">string</span>
        <span class="n">inputString</span> <span class="kt">string</span>
        <span class="n">expectedOutput</span> <span class="kt">string</span>
    <span class="p">}</span>

    <span class="k">var</span> <span class="n">tests</span> <span class="o">=</span> <span class="p">[]</span><span class="n">test</span><span class="p">{</span>
        <span class="p">{</span>
            <span class="n">name</span><span class="o">:</span> <span class="s">"basic string"</span><span class="p">,</span>
            <span class="n">inputString</span><span class="o">:</span> <span class="s">"hello"</span><span class="p">,</span>
            <span class="n">expectedOutput</span><span class="o">:</span> <span class="s">"olleh"</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="n">name</span><span class="o">:</span> <span class="s">"empty string"</span><span class="p">,</span>
            <span class="n">inputString</span><span class="o">:</span> <span class="s">""</span><span class="p">,</span>
            <span class="n">expectedOutput</span><span class="o">:</span> <span class="s">""</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="n">name</span><span class="o">:</span> <span class="s">"single character"</span><span class="p">,</span>
            <span class="n">inputString</span><span class="o">:</span> <span class="s">"a"</span><span class="p">,</span>
            <span class="n">expectedOutput</span><span class="o">:</span> <span class="s">"a"</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">tt</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">tests</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="k">func</span> <span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">output</span> <span class="o">:=</span> <span class="n">reverse</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">inputString</span><span class="p">)</span>
            <span class="n">assert</span><span class="o">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">expectedOutput</span><span class="p">,</span> <span class="s">"output does not match expectedOutput"</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>This is a good example for simple functions with no side effects but it can become more difficult to test functions that have to do things like make http requests or reach out to databases.</p><h2 id="more-complex-functions-and-mocking"><span class="mr-2">More Complex Functions and Mocking</span><a href="#more-complex-functions-and-mocking" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>For functions with more complex behavior we may have to mock certain interfaces. In this example we’ll look at a function that makes an api request using go’s builtin http client.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="k">type</span> <span class="n">MyData</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">Foo</span> <span class="kt">string</span> <span class="s">`json:"foo"`</span>
    <span class="n">Bar</span> <span class="kt">int</span> <span class="s">`json:"bar"`</span>
<span class="p">}</span>

<span class="k">var</span> <span class="p">(</span>
    <span class="n">ErrUserNotFound</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">"user not found"</span><span class="p">),</span>
    <span class="n">ErrServerError</span> <span class="o">=</span> <span class="n">errros</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">"server error"</span><span class="p">),</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">GetExampleData</span><span class="p">(</span><span class="n">userId</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">MyData</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">resp</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"http://example.com/api/%s"</span><span class="p">,</span> <span class="n">userId</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">err</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

    <span class="n">body</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">io</span><span class="o">.</span><span class="n">ReadAll</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">err</span>
    <span class="p">}</span>

    <span class="c">// If request had error return relevant one</span>
    <span class="k">switch</span> <span class="n">resp</span><span class="o">.</span><span class="n">StatusCode</span> <span class="p">{</span>
        <span class="k">case</span> <span class="m">404</span><span class="o">:</span>
            <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">ErrUserNotFound</span>
        <span class="k">case</span> <span class="m">500</span><span class="o">:</span>
            <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">ErrServerError</span>
    <span class="p">}</span>

    <span class="k">var</span> <span class="n">results</span> <span class="n">MyData</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">Unmashall</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">results</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">err</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="o">&amp;</span><span class="n">results</span><span class="p">,</span> <span class="no">nil</span>
<span class="p">}</span>
</pre></table></code></div></div><p>This is a much more complicated function that not only has input from the function parameters but is pulling in other data from a server as a result. We could test this function in the same way but that would mean making real requests to the server with real data each time we wanted to test which is not ideal.</p><p>To do the testing without actually making the requests each time we will use a package called <code class="language-plaintext highlighter-rouge">gock</code>. Gock intercepts http requests made during testing and returns fake data which we can define to match the data we are receiving from the server. This way we can give our function data in the same shape as the server would without having to actually make the requests.</p><p>To start our tests we want to define our fake routes with <code class="language-plaintext highlighter-rouge">gock</code>.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>
<span class="k">func</span> <span class="n">TestGetExampleData</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">defer</span> <span class="n">gock</span><span class="o">.</span><span class="n">Off</span><span class="p">()</span> <span class="c">// Ensures gock will not intercept routes after we are done testing</span>

    <span class="n">gock</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">"http://example.com"</span><span class="p">)</span><span class="o">.</span>                                  <span class="c">// Base URL we want to intercept</span>
        <span class="n">Get</span><span class="p">(</span><span class="s">"/api/good-user"</span><span class="p">)</span><span class="o">.</span>                                       <span class="c">// Path we want to match</span>
        <span class="n">Reply</span><span class="p">(</span><span class="m">200</span><span class="p">)</span><span class="o">.</span>                                                  <span class="c">// Status Code to Return</span>
        <span class="n">JSON</span><span class="p">(</span><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">interface</span><span class="p">{}{</span><span class="s">"foo"</span><span class="o">:</span> <span class="s">"test-val-0"</span><span class="p">,</span> <span class="s">"bar"</span><span class="o">:</span> <span class="m">23</span><span class="p">})</span> <span class="c">// Mock data to return</span>
<span class="p">}</span>
</pre></table></code></div></div><p>This route that we have setup will intercept a http request for <code class="language-plaintext highlighter-rouge">http://example.com/api/good-user</code> and instead of actually making the request simply return the JSON data as the “response”. We can do this for every test case we want to create</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="n">gock</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">"http://example.com"</span><span class="p">)</span><span class="o">.</span>
    <span class="n">Get</span><span class="p">(</span><span class="s">"/api/missing-user"</span><span class="p">)</span><span class="o">.</span>
    <span class="n">Reply</span><span class="p">(</span><span class="m">404</span><span class="p">)</span><span class="o">.</span>
    <span class="n">JSON</span><span class="p">(</span><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">interface</span><span class="p">{}{</span><span class="s">"error"</span><span class="o">:</span> <span class="s">"User missing-user not found"</span><span class="p">})</span>

<span class="n">gock</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">"http://example.com"</span><span class="p">)</span><span class="o">.</span>
    <span class="n">Get</span><span class="p">(</span><span class="s">"/api/server-error"</span><span class="p">)</span><span class="o">.</span>
    <span class="n">Reply</span><span class="p">(</span><span class="m">500</span><span class="p">)</span><span class="o">.</span>
    <span class="n">JSON</span><span class="p">(</span><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">interface</span><span class="p">{}{</span><span class="s">"error"</span><span class="o">:</span> <span class="s">"Server ran into an error while trying to process your request"</span><span class="p">})</span>
</pre></table></code></div></div><p>With these routes we can setup our test struct and loop just as before. Asserting our actuall outputs match what we expect.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre><td class="rouge-code"><pre><span class="k">type</span> <span class="n">test</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">name</span> <span class="kt">string</span>
    <span class="n">inputUserId</span> <span class="kt">string</span>
    <span class="n">expectedOutput</span> <span class="n">MyData</span>
    <span class="n">expectedError</span> <span class="kt">error</span>
<span class="p">}</span>

<span class="k">var</span> <span class="n">tests</span> <span class="o">=</span> <span class="p">[]</span><span class="n">test</span><span class="p">{</span>
    <span class="p">{</span>
        <span class="n">name</span><span class="o">:</span> <span class="s">"good response"</span><span class="p">,</span>
        <span class="n">inputUserId</span><span class="o">:</span> <span class="s">"good-user"</span><span class="p">,</span>
        <span class="n">expectedOutput</span><span class="o">:</span> <span class="n">MyData</span><span class="p">{</span> <span class="n">Foo</span><span class="o">:</span> <span class="s">"test-val-0"</span><span class="p">,</span> <span class="n">Bar</span><span class="o">:</span> <span class="m">23</span> <span class="p">},</span>
        <span class="n">expectedError</span><span class="o">:</span> <span class="no">nil</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="n">name</span><span class="o">:</span> <span class="s">"user missing"</span><span class="p">,</span>
        <span class="n">inputUserId</span><span class="o">:</span> <span class="s">"missing-user"</span><span class="p">,</span>
        <span class="n">expectedOutput</span><span class="o">:</span> <span class="n">MyData</span><span class="p">{},</span>
        <span class="n">expectedError</span><span class="o">:</span> <span class="n">ErrUserNotFound</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="n">name</span><span class="o">:</span> <span class="s">"server error"</span><span class="p">,</span>
        <span class="n">inputUserId</span><span class="o">:</span> <span class="s">"server-error"</span><span class="p">,</span>
        <span class="n">expectedOutput</span><span class="o">:</span> <span class="n">MyData</span><span class="p">{},</span>
        <span class="n">expectedError</span><span class="o">:</span> <span class="n">ErrServerError</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">tt</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">tests</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="k">func</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">GetExampleData</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">inputUserId</span><span class="p">)</span>

        <span class="c">// If we are supposed to get an error check we got the right one then exit the test</span>
        <span class="k">if</span> <span class="n">tt</span><span class="o">.</span><span class="n">expectedError</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
            <span class="n">assert</span><span class="o">.</span><span class="n">ErrorIs</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">expectedError</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c">// If we were not expecting an error make sure we didn't get one</span>
            <span class="n">assert</span><span class="o">.</span><span class="n">NoError</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c">// Make sure the data we got from our function is the data we should have gotten</span>
        <span class="n">assert</span><span class="o">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">expectedOutput</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Running this test will get the test data from our gock routes and parse them as if they were gotten from the real server without having to modify our functions to accept some mock client. For even more complex functions you may want to do more checking of the output but this should give you a good framework for how to structure tests in your go project.</p><h2 id="resources"><span class="mr-2">Resources</span><a href="#resources" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><strong>Testify</strong> - <a href="https://github.com/stretchr/testify">https://github.com/stretchr/testify</a></p><p><strong>Gock</strong> - <a href="https://github.com/h2non/gock">https://github.com/h2non/gock</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/programming/'>Programming</a>, <a href='/categories/golang/'>Golang</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/programming/" class="post-tag no-text-decoration" >programming</a> <a href="/tags/golang/" class="post-tag no-text-decoration" >golang</a> <a href="/tags/devops/" class="post-tag no-text-decoration" >devops</a> <a href="/tags/testing/" class="post-tag no-text-decoration" >testing</a> <a href="/tags/unittests/" class="post-tag no-text-decoration" >unittests</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Creating+Unit+Tests+in+Go+-+Grayton+Ward&url=%2Fposts%2Fcreating-unit-tests-golang%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Creating+Unit+Tests+in+Go+-+Grayton+Ward&u=%2Fposts%2Fcreating-unit-tests-golang%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Fcreating-unit-tests-golang%2F&text=Creating+Unit+Tests+in+Go+-+Grayton+Ward" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/creating-unit-tests-golang/">Creating Unit Tests in Go</a><li><a href="/posts/golang-pointers/">Understanding Golang Pointers</a><li><a href="/posts/starting-the-homelab-bible/">Starting My Homelab Bible</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ansible/">ansible</a> <a class="post-tag" href="/tags/automation/">automation</a> <a class="post-tag" href="/tags/golang/">golang</a> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/programming/">programming</a> <a class="post-tag" href="/tags/basics/">basics</a> <a class="post-tag" href="/tags/devops/">devops</a> <a class="post-tag" href="/tags/fundamentals/">fundamentals</a> <a class="post-tag" href="/tags/pointers/">pointers</a> <a class="post-tag" href="/tags/testing/">testing</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/golang-pointers/"><div class="card-body"> <em class="small" data-ts="1676869200" data-df="ll" > Feb 20, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Understanding Golang Pointers</h3><div class="text-muted small"><p> Even if you are familiar with a language that has pointers like C pointers in go may still give you some trouble. This short guide will assume you have no previous knowledge of pointers to give you...</p></div></div></a></div><div class="card"> <a href="/posts/setting-up-cloudinit/"><div class="card-body"> <em class="small" data-ts="1661486400" data-df="ll" > Aug 26, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Automating CloudInit Templates in Proxmox</h3><div class="text-muted small"><p> Automating CloudInit Templates in Proxmox Continuing from my last post on setting up my homelab bible the next thing I want to do is make it easy for me to spin up new vms in my environment from a...</p></div></div></a></div><div class="card"> <a href="/posts/starting-the-homelab-bible/"><div class="card-body"> <em class="small" data-ts="1660795200" data-df="ll" > Aug 18, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Starting My Homelab Bible</h3><div class="text-muted small"><p> Starting My Homelab Bible This will server as the start of my journey to create a set of ansible playbooks and tasks to be able to do all the things in my homelab from ansible. The other goal is ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/golang-pointers/" class="btn btn-outline-primary" prompt="Older"><p>Understanding Golang Pointers</p></a><div class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></div></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/graytonio">Grayton Ward</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ansible/">ansible</a> <a class="post-tag" href="/tags/automation/">automation</a> <a class="post-tag" href="/tags/golang/">golang</a> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/programming/">programming</a> <a class="post-tag" href="/tags/basics/">basics</a> <a class="post-tag" href="/tags/devops/">devops</a> <a class="post-tag" href="/tags/fundamentals/">fundamentals</a> <a class="post-tag" href="/tags/pointers/">pointers</a> <a class="post-tag" href="/tags/testing/">testing</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
